# Copyright 2024 Bytedance Ltd. and/or its affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# SWE Agent Loop Configuration for VERL
# =============================================================================
# 参考 SWE-agent/config/default.yaml 官方配置
# 针对小模型（Qwen2.5-3B）优化：
#   - system_template 明确 thought_action 格式（只放一个代码块）
#   - instance_template 强调最终要 submit 提交 patch
#   - max_requeries=5 给小模型更多重试机会
# =============================================================================

- name: swe_agent
  _target_: recipe.swe_agent.swe_agent_loop.SWEAgentLoop

  # ModelProxy 配置 - 拦截 SWE-Agent 的 API 请求
  proxy_config:
    port: 8080              # ModelProxy 监听端口（会自动递增避免冲突）
    timeout: 600            # 单次请求超时 (秒)

  # SWE-Agent 执行配置
  sandbox_config:
    swe_agent_timeout: 1800 # SWE-Agent 总执行时间限制 (秒)
    max_steps: 30           # 最大模型调用次数（简单任务 5~10 步足够）
    execution_timeout: 300  # 单次工具执行超时 (秒)
    output_dir: /data1/lmy/workspace/swe_agent_outputs  # 输出目录
    python_path: /usr/bin/python3.12  # 使用 python3.12 作为基础环境
    # 交互轮数上限，达到后中止当前任务
    max_turns: 15
    # deployment_type: "docker" 使用Docker隔离（默认，生产推荐）
    # deployment_type: "local" 跳过Docker容器（启动快，仅用于调试）
    deployment_type: docker
    # Docker 配置（仅当 deployment_type=docker 时生效）
    docker_image: swerex-python:3.11
    docker_memory_limit: 8g
    docker_startup_timeout: 180.0
    docker_remove_container: true

  # Agent 配置 - 针对小模型优化
  agent:
    # 格式错误后重试次数（默认3，小模型需要更多重试）
    max_requeries: 5
    templates:
      system_template: |-
        You are a helpful assistant that can interact with a computer to solve tasks.

        IMPORTANT: Every response MUST follow this exact format:

        DISCUSSION
        Your reasoning about what to do next.

        ```
        exactly_one_command_here
        ```

        Rules:
        - Include EXACTLY ONE code block (``` ```) per response
        - The code block must be the LAST thing in your response
        - The code block contains the bash command or tool command to execute
        - Do NOT put example outputs or other code blocks in your response
        - When you are done, run the `submit` command to submit your changes
      instance_template: |-
        <uploaded_files>
        {{working_dir}}
        </uploaded_files>
        I've uploaded a python code repository in the directory {{working_dir}}.

        <pr_description>
        {{problem_statement}}
        </pr_description>

        Implement the necessary changes to satisfy the <pr_description>.
        Do NOT modify any test files.

        Steps:
        1. Explore the repo with `ls` and `cat` to understand the code
        2. Make the required changes using `str_replace_editor` or bash commands
        3. Verify your changes work
        4. Run `submit` to submit your patch

        You MUST run `submit` when you are done to generate the final patch.
      next_step_template: |-
        OBSERVATION:
        {{observation}}
      next_step_no_output_template: |-
        Your command ran successfully and did not produce any output.
    tools:
      env_variables:
        PAGER: cat
        MANPAGER: cat
        LESS: -R
        PIP_PROGRESS_BAR: 'off'
        TQDM_DISABLE: '1'
        GIT_PAGER: cat
      bundles:
        - path: tools/registry
        - path: tools/edit_anthropic
        - path: tools/review_on_submit_m
      registry_variables:
        USE_FILEMAP: 'true'
      enable_bash_tool: true
      # 使用 thought_action 模式 - 适合纯文本生成的模型
      # function_calling 需要 OpenAI API 的 tool_calls 字段，Qwen 模型不支持
      parse_function:
        type: thought_action
    history_processors:
      - type: cache_control
        last_n_messages: 2
